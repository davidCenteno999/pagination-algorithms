<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMU Visualization Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h2 {
            text-align: center;
        }
        .memory-bars {
            width: 100%;
            height: 30px;
            margin: 10px 0;
            display: flex;
        }
        .memory-bars div {
            height: 100%;
        }
        .bar-opt div, .bar-alg div { flex: 1; }
        
        /* Colores */
        .lightblue { background-color: lightblue; }
        .lightgreen { background-color: lightgreen; }
        .lightcoral { background-color: lightcoral; }
        .lightyellow { background-color: lightyellow; }
        .peachpuff { background-color: peachpuff; }

        .summary-container {
            width: 85%;
            overflow: hidden;
        }

        .summary-table {
            width: 40%;
            float: center;
            margin: 20px 10px;
            border-collapse: collapse;
        }

        .summary-table td, .summary-table th {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }

        .summary-table2 {
            width: 40%;
            float: center;
            margin: 20px 10px;
            border-collapse: collapse;
            float: right;
        }

        .summary-table2 td, .summary-table2 th {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }


        .highlight-red {
            background-color: lightcoral;
        }

        .highlight-yellow {
            background-color: rgb(227, 227, 148);
        }

        .highlight-green {
            background-color: lightgreen;
        }
        table {
            border-collapse: collapse;
            width: 48%;
            margin: 20px 1%;
            float: left;
            text-align: center;
            display: block; /* Asegura el scroll en el tbody */
        }

        thead, tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed; /* Para mantener el tamaño fijo de las celdas */
        }

        tbody {
            display: block;
            height: 200px; /* Altura ajustada para ver 20 filas */
            overflow-y: scroll; /* Desplazamiento vertical */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            height: 25px; /* Ajuste de altura para cada fila (25px aprox) */
        }

        th {
            background-color: #f2f2f2;
        }
        .top-table-custom {
            width: 100%;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #000; /* Borde más grueso y verde */
            table-layout: fixed; /* Asegura el ancho fijo de las celdas */
            overflow: hidden;
        }

        .top-table-custom td {
            border: 2px solid #000;
            padding: 8px;
            font-weight: bold;
            
            width: 1%; /* Celdas estrechas */
        }
        .top-table-custom2 {
            width: 100%;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #000; /* Borde más grueso y verde */
            table-layout: fixed; /* Asegura el ancho fijo de las celdas */
            overflow: hidden;
        }

        .top-table-custom2 td {
            border: 2px solid #000;
            padding: 8px;
            font-weight: bold;
            
            width: 1%; /* Celdas estrechas */
        }

    </style>
</head>
<body>
    <h2>MMU Visualization</h2>


    <table class="top-table-custom">
        <tr id="top-row">

        </tr>
    </table>

    <table class="top-table-custom2">
        <tr id="top-row2">

        </tr>
    </table>

    <button id="continue-btn">Continue</button>
    <h3>Current Operation: <span id="current-operation"></span></h3>


    <div class="memory-bars bar-opt">
        <!-- The bars for OPT algorithm will be updated dynamically here -->
    </div>
    <div class="memory-bars bar-alg">
        <!-- The bars for ALG algorithm will be updated dynamically here -->
    </div>

    <!-- Tables for MMU-OPT and MMU-[ALG] -->
    <table id="opt-table">
        <thead>
            <tr>
                <th>PAGE ID</th>
                <th>PID</th>
                <th>LOADED</th>
                <th>L-ADDR</th>
                <th>M-ADDR</th>
                <th>D-ADDR</th>
                <th>LOADED-T</th>
                <th>MARK</th>
            </tr>
        </thead>
        <tbody id="opt-body">

        </tbody>
    </table>

    <table id="alg-table">
        <thead>
            <tr>
                <th>PAGE ID</th>
                <th>PID</th>
                <th>LOADED</th>
                <th>L-ADDR</th>
                <th>M-ADDR</th>
                <th>D-ADDR</th>
                <th>LOADED-T</th>
                <th>MARK</th>
            </tr>
        </thead>
        <tbody id="alg-body">
            <!-- ALG algorithm data will be dynamically inserted here -->
        </tbody>
    </table>

    <!-- Contenedor para el par de tablas 3 y 4 -->
    <div class="summary-container">
        <table class="summary-table" id="summary-2">
            <!-- Summary data for ALG algorithm will be dynamically inserted here -->
        </table>

        <table class="summary-table2" id="summary-4">
            <!-- Summary data for ALG algorithm will be dynamically inserted here -->
        </table>
    </div>


        <!-- Contenedor para el par de tablas 1 y 2 -->
    <div class="summary-container">
        <table class="summary-table2" id="summary-1">
            <!-- Summary data for OPT algorithm will be dynamically inserted here -->
        </table>

        <table class="summary-table" id="summary-3">
            <!-- Summary data for OPT algorithm will be dynamically inserted here -->
        </table>
    </div>

    


    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const topRow = document.getElementById('top-row');
            const topRow2 = document.getElementById('top-row2');
            
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('td');
                topRow.appendChild(cell);
            }
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('td');
                topRow2.appendChild(cell);
            }
            

            // Inicializa la conexión con el servidor para los datos de la MMU
            const eventSource = new EventSource("/simulate_stream");
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);  // Convertir los datos JSON enviados por el servidor
                
                // Actualizar las celdas según los datos de `data.opt`
                data.opt.forEach((page, index) => {
                    const cell = topRow.children[index];  // Obtener la celda correspondiente
                    
                    // Limpiar cualquier clase previa
                    cell.classList.remove('highlight-green', 'highlight-yellow', 'highlight-red');
                    
                    // Definir la clase según el valor de `page.pid % 3`
                    let rowClass = '';
                    const resultado = page.pid % 3;
                    if (resultado === 0) {
                        rowClass = 'highlight-green';
                    } else if (resultado === 1) {
                        rowClass = 'highlight-yellow';
                    } else {
                        rowClass = 'highlight-red';
                    }
                    
                    // Aplicar la nueva clase a la celda
                    cell.classList.add(rowClass);
                });
                data.alg.forEach((page, index) => {
                    const cell = topRow2.children[index];  // Obtener la celda correspondiente
                    
                    // Limpiar cualquier clase previa
                    cell.classList.remove('highlight-green', 'highlight-yellow', 'highlight-red');
                    
                    // Definir la clase según el valor de `page.pid % 3`
                    let rowClass = '';
                    const resultado = page.pid % 3;
                    if (resultado === 0) {
                        rowClass = 'highlight-green';
                    } else if (resultado === 1) {
                        rowClass = 'highlight-yellow';
                    } else {
                        rowClass = 'highlight-red';
                    }
                    
                    // Aplicar la nueva clase a la celda
                    cell.classList.add(rowClass);
                });
            };
        });


        // Function to send actions to the MMU server
        /*function sendMMUAction(action, pid = null, ptr = null, size = null) {
            fetch('/simulate_stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action, pid, ptr, size })
            })
            .then(response => response.json())
            .then(data => {
                updateTables(data);
            });
        }*/
        document.addEventListener("DOMContentLoaded", function() {
            const eventSource = new EventSource("/simulate_stream");

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);  // Convertir los datos JSON enviados por el servidor
                updateTables(data);  // Actualizar las tablas y las barras de memoria
            };
        });

        // Function to update the tables and summary data based on the MMU state
        function updateTables(data) {
            const optTableBody = document.getElementById('opt-body');
            const algTableBody = document.getElementById('alg-body');
            const currentOperationSpan = document.getElementById('current-operation');

            // Clear the previous table data
            optTableBody.innerHTML = '';
            algTableBody.innerHTML = '';
            

            
            // Fill the OPT table with new data
            data.opt.forEach(page => {
                let rowclass = '';
                resultado = page.pid % 3
                if (resultado == 0){
                    rowclass = 'highlight-green';
                }else if(resultado == 1){
                    rowclass = 'highlight-yellow';
                }else{
                    rowclass = 'highlight-red';
                }
                const row = `<tr class="${rowclass}">
                                <td>${page.page_id}</td>
                                <td>${page.pid}</td>
                                <td>${page.loaded}</td>
                                <td>${page.l_addr}</td>
                                <td>${page.m_addr}</td>
                                <td>${page.d_addr}</td>
                                <td>${page.loaded_t}s</td>
                                <td>${page.mark}</td>
                            </tr>`;
                optTableBody.innerHTML += row;
            });

            // Fill the ALG table with new data
           
            data.alg.forEach(page => {
                let rowclass = '';
                resultado = page.pid % 3
                if (resultado == 0){
                    rowclass = 'highlight-green';
                }else if(resultado == 1){
                    rowclass = 'highlight-yellow';
                }else{
                    rowclass = 'highlight-red';
                }
                const row = `<tr class="${rowclass}">
                                <td>${page.page_id}</td>
                                <td>${page.pid}</td>
                                <td>${page.loaded}</td>
                                <td>${page.l_addr}</td>
                                <td>${page.m_addr}</td>
                                <td>${page.d_addr}</td>
                                <td>${page.loaded_t}s</td>
                                <td>${page.mark}</td>
                            </tr>`;
                algTableBody.innerHTML += row;
                
            });

            // Update the summary tables
            document.getElementById('summary-1').innerHTML = `
                <tr><td>Total Pages</td><td>${data.summary_1.total_pages}</td></tr>
                <tr><td>Free Frames</td><td>${data.summary_1.free_frames}</td></tr>
                <tr><td>Loaded Pages</td><td>${data.summary_1.loaded_pages}</td></tr>
                <tr><td>Processes</td><td>${data.summary_1.processes}</td></tr>
                <tr><td>Sim-Time</td><td>${data.summary_1.simTime}s</td></tr>
                <tr><td>Thrashing</td><td>${data.summary_1.thrashing}s</td></tr>
                <tr><td>RAM KB</td><td>${data.summary_1.usedRam}</td></tr>
                <tr><td>RAM %</td><td>${data.summary_1.usedRamPer}</td></tr>
                <tr><td>VRAM KB</td><td>${data.summary_1.usedVRam}</td></tr>
            `;
            document.getElementById('summary-2').innerHTML = `
                <tr><td>Used Frames</td><td>${data.summary_2.used_frames}</td></tr>
                <tr><td>Algorithm</td><td>${
                data.summary_2.algorithm === 0 ? 'FIFO' :
                data.summary_2.algorithm === 1 ? 'SC' :
                data.summary_2.algorithm === 2 ? 'MRU' : 'RND'
                }</td></tr>
                
                <tr><td>Loaded Pages</td><td>${data.summary_1.loaded_pages}</td></tr>
            `;

            document.getElementById('summary-3').innerHTML = `
                <tr><td>Total Pages</td><td>${data.summary_3.total_pages}</td></tr>
                <tr><td>Free Frames</td><td>${data.summary_3.free_frames}</td></tr>
                <tr><td>Loaded Pages</td><td>${data.summary_3.loaded_pages}</td></tr>
                <tr><td>Processes</td><td>${data.summary_3.processes}</td></tr>
                <tr><td>Sim-Time</td><td>${data.summary_3.simTime}s</td></tr>
                <tr><td>Thrashing</td><td>${data.summary_3.thrashing}s</td></tr>
                <tr><td>RAM KB</td><td>${data.summary_3.usedRam}</td></tr>
                <tr><td>RAM %</td><td>${data.summary_3.usedRamPer}</td></tr>
                <tr><td>VRAM KB</td><td>${data.summary_3.usedVRam}</td></tr>
            `;
            document.getElementById('summary-4').innerHTML = `
                <tr><td>Used Frames</td><td>${data.summary_2.used_frames}</td></tr>
                <tr><td>Algorithm</td><td>${
                data.summary_4.algorithm === 0 ? 'FIFO' :
                data.summary_4.algorithm === 1 ? 'SC' :
                data.summary_4.algorithm === 2 ? 'MRU' : 'RND'
                }</td></tr>
                
                <tr><td>Loaded Pages</td><td>${data.summary_4.loaded_pages}</td></tr>
            `;
            


            currentOperationSpan.innerText = data.current_operation;
        }
    </script>
    

    <script>
    document.getElementById("continue-btn").addEventListener("click", function() {
        fetch('/continue')
        .then(response => response.json())
        .then(data => {
            console.log("Simulation continued:", data);
        });
    });
    </script>
</body>
</html>